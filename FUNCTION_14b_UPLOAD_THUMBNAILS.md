# Function 14b: Upload Thumbnails via Selenium (Part 2 of 2)

## Overview

**Function 14b** completes the thumbnail upload process started by Function 14a. It uses Selenium browser automation to upload processed thumbnail files to Alma representations via the web interface.

**Why Selenium?** The Alma API file upload endpoint has a limitation that prevents binary file uploads (UTF-8 parsing error). Function 14b works around this by automating the manual upload process through the Alma web interface.

## Prerequisites

### Required Software
1. **Firefox** web browser installed
2. **GeckoDriver** installed (required for Selenium to control Firefox)
   ```bash
   # macOS (via Homebrew)
   brew install geckodriver
   
   # Or download from: https://github.com/mozilla/geckodriver/releases
   ```
3. **Python selenium package** (should be installed via requirements.txt)

### Required Setup
1. **GeckoDriver installed** (Selenium Firefox driver)
   ```bash
   # macOS (via Homebrew)
   brew install geckodriver
   ```

2. **CSV file from Function 14a** containing representation IDs and file paths
   - Located in `~/Downloads/CABB_thumbnail_prep_YYYYMMDD_HHMMSS/`
   - Contains columns: `mms_id`, `rep_id`, `filename`, `original_file`

### Workflow

**Simple Process:**

1. Click "14b - Upload Thumbnails" in CABB
2. Enter the CSV file path in the "Set ID" field
3. Click Proceed in the warning dialog
4. **Selenium launches a NEW Firefox window**
5. **You have 45 seconds to log into Alma via Grinnell SSO**
6. Automation begins automatically
7. Do not interact with Firefox during uploads

**Note**: Selenium **cannot** attach to your existing Firefox session—it must launch its own window. This is a Selenium/GeckoDriver limitation. The browser navigates to the SSO login page automatically (`https://grinnell.alma.exlibrisgroup.com/SAML`).

## How It Works

### Input
- **CSV File Path**: Enter the path to the CSV file generated by Function 14a in the "Set ID" field
- The CSV must have these columns:
  - `mms_id`: Bibliographic record MMS ID
  - `rep_id`: Representation ID (created by Function 14a)
  - `filename`: Full path to processed thumbnail file
  - `original_file`: Full path to original file (for reference)

### Process Flow

For each record in the CSV file:

1. **Configure Search Bar**
   - Sets search type to "Digital titles"
   - Sets search field to "Representation PID"

2. **Search for Representation**
   - Enters the representation ID
   - Clicks search (magnifying glass icon)
   - Waits for results

3. **Open Digital Representations**
   - Finds and clicks "Digital Representations (X)" link
   - Waits for modal/window to open

4. **Select Specific Representation**
   - Locates the representation ID link
   - Clicks to open representation details

5. **Upload Thumbnail**
   - Clicks "Thumbnail Upload" file selector
   - Navigates to the processed file path
   - Waits for file to be selected

6. **Save**
   - Clicks "Save" button
   - Waits for save to complete
   - Moves to next record

## Usage

### Step 1: Start Firefox with Marionette
1. **Close Firefox completely** if it's currently running
2. **Start Firefox with remote debugging enabled**:
   ```bash
   # macOS - open Firefox with marionette enabled
   open -a Firefox --args --marionette
   ```
   Or use the full path:
   ```bash
   /Applications/Firefox.app/Contents/MacOS/firefox --marionette
   ```
3. **Log into Alma** in the Firefox window
4. **Navigate to the Alma home page**:
   ```
   https://grinnell.alma.exlibrisgroup.com/SAML
   ```
5. **Leave Firefox open** - Selenium will connect to this window

### Step 2: Prepare CSV Path
1. Locate the CSV file path from Function 14a output
   - Example: `~/Downloads/CABB_thumbnail_prep_20260226_135924/thumbnail_representations_20260226_135924.csv`

### Step 3: Run Function 14b
1. In CABB, enter the CSV file path in the **Set ID** field
   - Example: `~/Downloads/CABB_thumbnail_prep_20260226_135924/thumbnail_representations_20260226_135924.csv`
   - Must use absolute path with ~/Downloads/
2. Verify Firefox is running with `--marionette` flag and you're logged into Alma
3. Select "14b: Upload Thumbnails (Part 2 of 2)" from the function dropdown
4. Click the function button
5. **Review the warning dialog carefully**
6. Click "Proceed" to start

### Step 4: Selenium Connects and Processes
1. Selenium connects to your existing Firefox window (the one you started with `--marionette`)
2. If not already on Alma, it navigates to the home page
3. Automation begins processing CSV records
4. **Do not interact with Firefox** while uploads are in progress

### Step 5: Monitor Progress
- **Do not interact with Firefox** while the upload is running
- Watch the progress bar in CABB
- Monitor the log output for status updates
- Each record will show:
  - ✓ Successfully uploaded
  - ✗ Failed (with error details)

### Step 4: Review Results
- Firefox will be **left open** after completion
- You can review the last uploaded record
- Check the log for any failures
- Manually verify uploads in Alma if needed

### Step 5: Completion Dialog
After all uploads complete, a dialog will appear showing:
- **Number of successful uploads** (✓)
- **Number of failed uploads** (✗)
- **Temporary directory location**

**If all uploads were successful (no errors):**
- You'll see a "Delete Temp Directory" button
- Click it to automatically clean up the temporary files
- This removes the `~/Downloads/CABB_thumbnail_prep_*` directory

**If some uploads failed:**
- The temporary directory is **preserved** for review
- You can manually check the files and retry failed uploads
- Delete the directory manually when you're done

## Output

### Log Messages
For each record:
```
[1/10] Processing MMS ID: 991011591726004641
  Rep ID: 12349493040004641
  File: /path/to/grinnell_19458_thumbnail.jpg
  Step 1: Configuring search bar...
    ✓ Set search type to 'Digital titles'
    ✓ Set search field to 'Representation PID'
  Step 2: Searching for representation 12349493040004641...
    ✓ Search initiated
  Step 3: Opening Digital Representations...
    ✓ Opened Digital Representations
  Step 4: Opening representation 12349493040004641...
    ✓ Opened representation
  Step 5: Uploading thumbnail file...
    ✓ Selected file: grinnell_19458_thumbnail.jpg
    ✓ Clicked Save
  ✓ Successfully uploaded thumbnail for 991011591726004641
```

### Final Summary
```
Thumbnail upload complete: 45 uploaded, 2 failed
⚠️ NOTE: Firefox browser has been left open for your review
```

## Important Notes

### Browser Control
- **Do not interact with Firefox** while Function 14b is running
- Selenium controls the browser programmatically
- Any manual clicks or keystrokes may disrupt the process
- If you need to stop, use the Kill Switch in CABB

### Error Handling
If an upload fails, the function:
- Logs the error with details
- Continues to the next record
- Provides a summary at the end

Common errors:
- **Timeout**: Page didn't load in time (may need to increase wait time)
- **Element not found**: Page structure changed or wrong page loaded
- **File not found**: File path in CSV is incorrect

### Manual Intervention
If uploads fail:
1. Check the log for specific error messages
2. Verify Firefox is on the correct Alma page
3. Ensure you're logged in and have permissions
4. Check that file paths in the CSV are correct
5. Try running again with a subset of records

### Performance
- Uploads are sequential (one at a time)
- Each upload takes approximately 5-10 seconds
- Large batches may take significant time
- Consider running in smaller batches (50-100 records)

## Troubleshooting

### "Could not start Firefox"
- **Cause**: GeckoDriver not installed or not in PATH
- **Solution**: 
  ```bash
  brew install geckodriver
  ```
- **Verify**:
  ```bash
  geckodriver --version
  ```

### "Connection aborted" or "BadStatusLine" error
- **Cause**: This was a previous approach that tried to connect to existing Firefox (doesn't work)
- **Solution**: Updated code now launches a NEW Firefox window automatically
- **What changed**: Selenium can't attach to existing sessions, so we simplified the workflow

### "Connection refused" or "Unable to connect"
- **Cause**: Firefox not running or marionette not enabled
- **Solution**: Verify Firefox is running and was started with `--marionette` flag
- Check if port 2828 is available (marionette default port)

### "GeckoDriver executable needs to be in PATH"
- **Solution**: Install GeckoDriver: `brew install geckodriver` (macOS)
- Or download from: https://github.com/mozilla/geckodriver/releases

### "Timeout waiting for page element"
- **Cause**: Page took too long to load or wrong page
- **Solution**: Check network connection, verify you're logged into Alma
- May need to manually navigate back to home page

### "Element not found"
- **Cause**: Alma page structure changed or unexpected page state
- **Solution**: Check Firefox to see what page is displayed
- May need to update element selectors in code

### "File not found"
- **Cause**: File path in CSV is incorrect or file was moved
- **Solution**: Verify file exists at the path specified in CSV
- Re-run Function 14a if files were moved

### Firefox closes during process
- **Cause**: Firefox crashed or was manually closed
- **Solution**: Restart Firefox, log back into Alma, run again
- Consider processing in smaller batches

## Best Practices

1. **Test First**: Run on a single record before processing large batches
2. **Small Batches**: Process 50-100 records at a time for easier troubleshooting
3. **Monitor Closely**: Watch the first few uploads to ensure everything works
4. **Keep Backups**: Keep the CSV file and thumbnail files until upload is confirmed
5. **Verify Results**: Spot-check uploaded thumbnails in Alma after completion
6. **Network**: Ensure stable internet connection throughout the process

## Technical Details

### Selenium WebDriver
- Uses Firefox WebDriver (GeckoDriver)
- Automation is visible - you can see what's happening
- Waits up to 10 seconds for elements to appear
- Uses explicit waits for better reliability

### Element Selectors
The function uses these selectors (may need adjustment if Alma UI changes):
- Search type dropdown: `id="searchType"`
- Search field dropdown: `id="searchField"`
- Search input: `id="searchInput"`
- Search button: `id="searchButton"`
- Thumbnail upload input: `id="thumbnailUpload"`
- Save button: `id="saveButton"`

If these change, the code will need to be updated with new selectors.

## Version History

- **v1.0** (2026-02-26): Initial implementation with Selenium automation
  - Browser-based file upload via Alma UI
  - CSV input from Function 14a
  - Progress tracking and error handling
  - Firefox left open for review

## Related Functions

- **Function 14a**: Prepare Thumbnails (creates representations and processes files)
- **Function 11**: Identify Single TIFF Representations (identifies records needing thumbnails)

## See Also

- [Selenium Documentation](https://selenium-python.readthedocs.io/)
- [GeckoDriver Installation](https://github.com/mozilla/geckodriver/releases)
- [Function 14a Documentation](FUNCTION_14a_PREPARE_THUMBNAILS.md)
